#!/usr/bin/env python

import pipestash
import pipestash.producer
import pipestash.consumer
import pipestash.output.redisoutput
import pipestash.output.sleepyoutput
import queue
import os

def main():
    config = pipestash.parseargs()

    # set the niceness value
    os.nice(config.nice)

    # create queue
    msgqueue = queue.Queue(maxsize = config.queue_size)

    # instantiate output plugin
    output = pipestash.output.redisoutput.RedisOutput(config)

    # start the queue consumer thread
    consumer = pipestash.consumer.Consumer(msgqueue, output, config)
    consumer.setDaemon(True)
    consumer.start()

    # start the producer
    pipestash.producer.produce(config, msgqueue)

    # wait until the queue is done
    msgqueue.join()
if __name__ == "__main__":
    main()
